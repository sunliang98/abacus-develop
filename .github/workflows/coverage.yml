name: Coverage Analysis

on:
  pull_request:
    branches:
      - develop
  workflow_dispatch:
  push:
    tags:
      - 'v*'
jobs:
  test-coverage:
    name: Generate Coverage Report
    runs-on: X64
    container: ghcr.io/deepmodeling/abacus-gnu
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Install Perl Dependencies and Coverage Tools
        run: |
          apt update && apt install -y curl jq ca-certificates python3-pip
          # 首先安装系统版本的 lcov 和 Perl 依赖
          apt install -y lcov perl-modules
          # 安装必要的 Perl 模块
          apt install -y libcapture-tiny-perl libdatetime-perl libjson-perl libperlio-gzip-perl
          # 验证系统 lcov 是否工作
          lcov --version
          # 同时安装 gcovr 作为备用方案
          pip3 install gcovr
      
      - name: Building with Coverage
        run: |
          rm -rf build/
          rm -f CMakeCache.txt
          # 确保构建目录权限
          mkdir -p build
          chmod -R 755 build/
          # 使用明确的覆盖率标志
          cmake -B build \
            -DENABLE_COVERAGE=ON \
            -DBUILD_TESTING=ON \
            -DENABLE_MLALGO=ON \
            -DENABLE_LIBXC=ON \
            -DENABLE_LIBRI=ON \
            -DENABLE_GOOGLEBENCH=ON \
            -DENABLE_RAPIDJSON=ON \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"
          cmake --build build -j`nproc` || echo "Some tests failed but continuing for coverage"
          cmake --install build || echo "Some tests failed but continuing for coverage"
      
      - name: Testing
        env:
          OMP_NUM_THREADS: 1
        run: |
          # 运行测试前确保权限
          chmod -R 755 build/
          cmake --build build --target test ARGS="-V --timeout 21600" || echo "Some tests failed but continuing for coverage"
      
      - name: Generate Coverage Data
        run: |
          cd build
          # 检查 .gcno 和 .gcda 文件是否存在
          echo "Checking for coverage files:"
          find . -name "*.gcno" | head -10
          find . -name "*.gcda" | head -10
          
          # 方法1: 使用更新后的 lcov
          echo "Generating coverage with lcov..."
          lcov --directory . --capture --output-file coverage.info || echo "lcov failed, will try gcovr"
          
          # 过滤覆盖率数据
          lcov --remove coverage.info '/usr/*' '*/test/*' '*/external/*' '*/build/*' --output-file coverage.filtered.info || echo "lcov filtering failed"
          
          # 生成HTML报告用于检查
          genhtml coverage.filtered.info --output-directory coverage-report || echo "genhtml failed"
          
          # # 方法2: 使用 gcovr 作为备用
          # echo "Generating coverage with gcovr..."
          # gcovr -r .. --html --html-details -o coverage-gcovr.html --print-summary || echo "gcovr failed"
          
          # # 同时生成 gcovr 的 XML 格式，Codecov 更喜欢这种格式
          # gcovr -r .. --xml -o coverage.xml || echo "gcovr xml failed"
          
          cd ..
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        if: ${{ ! cancelled() }}
        with:
          fail_ci_if_error: false  # 设置为 false 避免因覆盖率收集失败而整个 CI 失败
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/coverage.xml,./build/coverage.info  # 提供多个文件选项
          directory: ./build/
          flags: unittests
          name: codecov-umbrella
          verbose: true
      
      - name: Upload Coverage Report Artifact
        uses: actions/upload-artifact@v4
        if: always()  # 即使前面的步骤失败也上传，便于调试
        with:
          name: coverage-report
          path: |
            build/coverage-report/
            build/coverage.info
            build/coverage.xml
          retention-days: 30